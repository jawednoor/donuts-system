<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اختبار الاتصال - Google Apps Script</title>
  <link rel="icon" type="image/png" href="logo-01.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      direction: rtl;
    }

    .test-container {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      max-width: 600px;
      width: 90%;
      text-align: center;
    }

    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 1rem;
      border-radius: 50%;
      background: #f8f9fa;
      padding: 10px;
    }

    h1 {
      color: #333;
      margin-bottom: 2rem;
      font-size: 1.8rem;
    }

    .test-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .form-group {
      text-align: right;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #555;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      direction: rtl;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-test {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin: 1rem 0;
    }

    .btn-test:hover {
      transform: translateY(-2px);
    }

    .btn-test:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .result-box {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin-top: 1rem;
      text-align: right;
      min-height: 100px;
      border: 2px solid #e1e5e9;
    }

    .success {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }

    .loading {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
    }

    .status-success { background: #28a745; }
    .status-error { background: #dc3545; }
    .status-loading { background: #ffc107; }

    .test-data {
      background: #e9ecef;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-family: monospace;
      text-align: left;
      direction: ltr;
      font-size: 14px;
      overflow-x: auto;
    }

    .back-link {
      display: inline-block;
      margin-top: 2rem;
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .back-link:hover {
      color: #764ba2;
    }

    @media (max-width: 768px) {
      .test-container {
        margin: 1rem;
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="test-container">
    <img src="logo-01.png" alt="شعار دونات وحشوة" class="logo">
    <h1>🧪 اختبار الاتصال مع Google Apps Script</h1>
    
    <div style="background: #e3f2fd; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: right;">
      <strong>📋 معلومات الاختبار:</strong><br>
      <small>• الهدف: شيت "payments" في Google Sheets</small><br>
      <small>• نوع البيانات: payment</small><br>
      <small>• سيتم إضافة صف جديد في شيت الدفعات</small>
    </div>
    
    <form class="test-form" id="testForm">
      <div class="form-group">
        <label for="testCustomer">اسم العميل (للاختبار):</label>
        <input type="text" id="testCustomer" value="عميل تجريبي" required>
      </div>
      
      <div class="form-group">
        <label for="testAmount">المبلغ:</label>
        <input type="number" id="testAmount" value="100" min="1" required>
      </div>
      
      <div class="form-group">
        <label for="testInvoice">رقم الفاتورة:</label>
        <input type="text" id="testInvoice" value="TEST-001" required>
      </div>
      
      <div class="form-group">
        <label for="testPayment">طريقة الدفع:</label>
        <select id="testPayment" required>
          <option value="نقدي">نقدي</option>
          <option value="تحويل بنكي">تحويل بنكي</option>
          <option value="فيزا">فيزا</option>
          <option value="مدى">مدى</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="testMobile">رقم الجوال:</label>
        <input type="text" id="testMobile" value="0512345678" pattern="^05[0-9]{8}$" required>
      </div>
      
      <button type="submit" class="btn-test" id="testBtn">
        🚀 اختبار الاتصال
      </button>
    </form>
    
    <div class="result-box" id="resultBox">
      <p>👈 اضغط على "اختبار الاتصال" لبدء الاختبار</p>
    </div>
    
    <div class="test-data" id="testData" style="display: none;">
      <strong>البيانات المرسلة:</strong>
      <pre id="sentData"></pre>
    </div>
    
    <a href="pay.html" class="back-link">← العودة لصفحة الدفعات</a>
  </div>

  <script>
    document.getElementById('testForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const testBtn = document.getElementById('testBtn');
      const resultBox = document.getElementById('resultBox');
      const testDataBox = document.getElementById('testData');
      const sentDataPre = document.getElementById('sentData');
      
      // تعطيل الزر وإظهار حالة التحميل
      testBtn.disabled = true;
      testBtn.innerHTML = '<div class="spinner"></div> جاري الاختبار...';
      
      resultBox.className = 'result-box loading';
      resultBox.innerHTML = `
        <div class="status-indicator status-loading"></div>
        <strong>🔄 جاري اختبار الاتصال...</strong><br>
        يتم إرسال البيانات إلى Google Apps Script...
      `;
      
      // جمع البيانات
      const testData = {
        type: 'payment',
        customer: document.getElementById('testCustomer').value,
        date: new Date().toISOString().split('T')[0],
        amount: parseFloat(document.getElementById('testAmount').value),
        invoiceNumber: document.getElementById('testInvoice').value,
        paymentMethod: document.getElementById('testPayment').value,
        mobile: document.getElementById('testMobile').value,
        notes: 'اختبار اتصال - ' + new Date().toLocaleString('ar-SA')
      };
      
      // إظهار البيانات المرسلة
      sentDataPre.textContent = JSON.stringify(testData, null, 2);
      testDataBox.style.display = 'block';
      
      console.log('🧪 بيانات الاختبار:', testData);
      
      try {
        // إرسال البيانات
        const startTime = Date.now();
        
        const response = await fetch('https://script.google.com/macros/s/AKfycby9A3DooXLq9-Y7q2qtUcY2WPAgs9qF_HAujPCeYFFviLLMAc0GWAiGF0_OjnGQTHbTQA/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(testData)
        });
        
        const endTime = Date.now();
        const duration = endTime - startTime;
        
        console.log('✅ تم إرسال البيانات بنجاح');
        console.log('⏱️ مدة الاستجابة:', duration + 'ms');
        
        // نجح الإرسال
        resultBox.className = 'result-box success';
        resultBox.innerHTML = `
          <div class="status-indicator status-success"></div>
          <strong>✅ نجح الاختبار!</strong><br>
          تم إرسال البيانات بنجاح إلى Google Apps Script<br>
          <strong>📊 تحقق من شيت "payments" في Google Sheets</strong><br>
          <small>مدة الاستجابة: ${duration}ms</small><br>
          <small>الوقت: ${new Date().toLocaleString('ar-SA')}</small>
        `;
        
      } catch (error) {
        console.error('❌ خطأ في الاختبار:', error);
        
        // فشل الإرسال
        resultBox.className = 'result-box error';
        resultBox.innerHTML = `
          <div class="status-indicator status-error"></div>
          <strong>❌ فشل الاختبار!</strong><br>
          خطأ في الاتصال: ${error.message}<br>
          <small>الوقت: ${new Date().toLocaleString('ar-SA')}</small><br>
          <small>تحقق من:</small><br>
          <small>• صحة رابط Google Apps Script</small><br>
          <small>• إعدادات الـ Script في Google</small><br>
          <small>• اتصال الإنترنت</small>
        `;
      } finally {
        // إعادة تفعيل الزر
        testBtn.disabled = false;
        testBtn.innerHTML = '🚀 اختبار الاتصال';
      }
    });
    
    // إعداد التاريخ الحالي عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🧪 صفحة اختبار الاتصال جاهزة');
      console.log('🔗 Google Apps Script URL:', 'AKfycby9A3DooXLq9-Y7q2qtUcY2WPAgs9qF_HAujPCeYFFviLLMAc0GWAiGF0_OjnGQTHbTQA');
      console.log('📊 الهدف: شيت "payments" في Google Sheets');
      console.log('📝 نوع البيانات: payment');
    });
  </script>
</body>
</html>
