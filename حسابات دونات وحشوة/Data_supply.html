<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุตูุญุฉ ุงูุชูุฑูุฏ - ุฏููุงุช ูุญุดูุฉ</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main>
    <div class="form-container">
      <div class="form-header">
        <img src="logo-01.png" alt="ุดุนุงุฑ ุฏููุงุช ูุญุดูุฉ" class="form-logo">
        <h2>ูููุฐุฌ ุงูุชูุฑูุฏ</h2>
      </div>
      
      <form id="supplyForm" class="payment-form">
        <div class="form-group">
          <label for="customer">ุงุฎุชุฑ ุงูุนููู:</label>
          <select id="customer" required>
            <option value="">ุงุฎุชุฑ ุงูุนููู...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="mobile">ุฑูู ุฌูุงู ุงููุณุชูู (ูุงุชุณ):</label>
          <input type="tel" id="mobile" pattern="05[0-9]{8}" placeholder="05xxxxxxxx" required>
        </div>

        <div class="form-group">
          <label for="date">ุชุงุฑูุฎ ุงูููู:</label>
          <input type="date" id="date" required>
        </div>

        <div class="form-group">
          <label for="product">ุงูุตูู:</label>
          <select id="product" required>
            <option value="">ุงุฎุชุฑ ุงูุตูู...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="qtyIn">ูููุฉ ุงูุชุณููู:</label>
          <select id="qtyIn" required>
            <option value="">ุงุฎุชุฑ ุงููููุฉ...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="qtyOut">ูููุฉ ุงููุณุชุฑุฏุฉ:</label>
          <select id="qtyOut" required>
            <option value="">ุงุฎุชุฑ ุงููููุฉ...</option>
          </select>
        </div>

        <button type="submit" class="btn-submit">๐ค ุฅุฑุณุงู ุงูุชูุฑูุฏ</button>
      </form>

      <div id="whatsappLink" class="whatsapp-link" style="display: none;">
        <p>ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ! ููููู ุงูุขู ุฅุฑุณุงู ุงูุชุฃููุฏ ุนุจุฑ ูุงุชุณุงุจ:</p>
        <a id="whatsappUrl" target="_blank" class="btn-whatsapp">๐ฑ ุฅุฑุณุงู ุนุจุฑ ูุงุชุณุงุจ</a>
      </div>

      <!-- ุฃุฒุฑุงุฑ ุงูุชููู ุงูุตุบูุฑุฉ -->
      <div class="small-nav-buttons">
        <a href="index.html" class="btn-small">ุงูุฑุฆูุณูุฉ</a>
        <a href="pay.html" class="btn-small">ุงูุฏูุนุงุช ุงููุงููุฉ</a>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 ูุธุงู ุฅุฏุงุฑุฉ ุชูุฑูุฏ ุงูุฏููุงุช ูุงูุญุดูุฉ</p>
  </footer> 
  <script>
    // ุชุนุจุฆุฉ ุงููููุฉ ูู 1 ุฅูู 100
    function fillSelect(id) {
      const sel = document.getElementById(id);
      for (let i = 0; i <= 100; i++) {
        const option = document.createElement('option');
        option.value = option.textContent = i;
        sel.appendChild(option);
      }
    }
    fillSelect('qtyIn');
    fillSelect('qtyOut');

    // ุฌูุจ ุจูุงูุงุช ุงูุนููุงุก ูู Google Sheets
    function loadCustomers() {
      const customerSel = document.getElementById('customer');
      
      // ุฅุถุงูุฉ ุฎูุงุฑ ูุงุฑุบ ุฃููุงู
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'ุงุฎุชุฑ ุงูุนููู';
      emptyOption.selected = true;
      customerSel.appendChild(emptyOption);
      
      // ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู Google Sheets
      tryLoadFromGoogleSheets();
    }
    
    // ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู Google Sheets ุงููุดุงุฑู
    function tryLoadFromGoogleSheets() {
      // ุงุณุชุฎุฏุงู ุฑุงุจุท CSV ูุจุงุดุฑ ููุดูุช ุงููุดุงุฑู
      const CUSTOMER_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1POl2ntUZL9x0n79Wr1_ZswEETSFUrgjMrXcFtDfoFqA/export?format=csv&gid=0';
      
      fetch(CUSTOMER_SHEET_URL)
        .then(res => res.text())
        .then(csvData => {
          console.log('ุชู ุงูุงุชุตุงู ุจู Google Sheets ุจูุฌุงุญ');
          console.log('CSV Data:', csvData.substring(0, 200) + '...'); // ุนุฑุถ ุฃูู 200 ุญุฑู ููุชุดุฎูุต
          
          const lines = csvData.split('\n');
          const customerSel = document.getElementById('customer');
          const uniqueCustomers = new Set(); // ูุชุฌูุจ ุงูุชูุฑุงุฑ
          
          // ูุนุงูุฌุฉ ุงูุจูุงูุงุช ูู CSV
          lines.forEach((line, index) => {
            if (index === 0) return; // ุชุฎุทู ุงูุฑุฃุณ
            
            const columns = line.split(',');
            if (columns.length > 1) {
              // ุฃุฎุฐ ุงูุนููุฏ ุงูุซุงูู (ุงูุนููุฏ B) ูุชูุธููู ููุนููุงุก
              let customer = columns[1];
              if (customer) {
                customer = customer.trim().replace(/"/g, '').replace(/'/g, '');
                
                if (customer && customer !== '' && customer !== 'undefined') {
                  uniqueCustomers.add(customer); // ุฅุถุงูุฉ ูููุฌููุนุฉ ูุชุฌูุจ ุงูุชูุฑุงุฑ
                }
              }
            }
          });
          
          // ูุณุญ ุงููุงุฆูุฉ ุงูุญุงููุฉ
          customerSel.innerHTML = '';
          
          // ุฅุถุงูุฉ ุฎูุงุฑ ูุงุฑุบ ุฃููุงู
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = 'ุงุฎุชุฑ ุงูุนููู';
          emptyOption.selected = true;
          customerSel.appendChild(emptyOption);
          
          // ุฅุถุงูุฉ ุงูุนููุงุก ุงููุฑูุฏูู
          uniqueCustomers.forEach(customer => {
            const opt = document.createElement('option');
            opt.value = customer;
            opt.textContent = customer;
            customerSel.appendChild(opt);
          });
          
          console.log('ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ูู Google Sheets:', uniqueCustomers.size, 'ุนููู ูุฑูุฏ');
          
          if (customerSel.options.length > 1) {
            alert('ุชู ุชุญููู ุจูุงูุงุช ุงูุนููุงุก ุงูุญุฏูุซุฉ ูู Google Sheets ุจูุฌุงุญ!');
          }
        })
        .catch(err => {
          console.error('ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู Google Sheets:', err);
          console.log('ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงูุงุญุชูุงุทูุฉ');
        });
    }
    
    // ุชุญููู ุงูุฃุตูุงู ูู Google Sheets ููุณ ุงูุดูุช Customer
    function loadProducts() {
      // ุฃุตูุงู ุงุญุชูุงุทูุฉ
      const backupProducts = ['ุฏููุงุช ูุญุดูุฉ', 'ุณููุงุจูู', 'ููููุฒ'];
      const productSel = document.getElementById('product');
      
      // ุฅุถุงูุฉ ุฎูุงุฑ ูุงุฑุบ ุฃููุงู
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'ุงุฎุชุฑ ุงูุตูู';
      productSel.appendChild(emptyOption);
      
      // ุฅุถุงูุฉ ุงูุฃุตูุงู ุงูุงุญุชูุงุทูุฉ ุฃููุงู
      backupProducts.forEach(product => {
        const opt = document.createElement('option');
        opt.value = product;
        opt.textContent = product;
        productSel.appendChild(opt);
      });
      
      console.log('ุชู ุชุญููู ุงูุฃุตูุงู ุงูุงุญุชูุงุทูุฉ:', backupProducts.length, 'ุตูู');
      
      // ูุญุงููุฉ ุฌูุจ ุงูุฃุตูุงู ูู Google Sheets
      tryLoadProductsFromGoogleSheets();
    }
    
    // ุฌูุจ ุงูุฃุตูุงู ูู Google Sheets
    function tryLoadProductsFromGoogleSheets() {
      // ุงุณุชุฎุฏุงู ููุณ ุฑุงุจุท ุงูุดูุช Customer
      const PRODUCTS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1POl2ntUZL9x0n79Wr1_ZswEETSFUrgjMrXcFtDfoFqA/export?format=csv&gid=0';
      
      fetch(PRODUCTS_SHEET_URL)
        .then(res => res.text())
        .then(csvData => {
          console.log('ุชู ุงูุงุชุตุงู ุจู Google Sheets ูุฌูุจ ุงูุฃุตูุงู');
          
          const lines = csvData.split('\n');
          const productSel = document.getElementById('product');
          const uniqueProducts = new Set(); // ูุชุฌูุจ ุงูุชูุฑุงุฑ
          
          // ูุนุงูุฌุฉ ุงูุจูุงูุงุช ูู CSV - ุงูุนููุฏ B (ูุคุดุฑ 1) ููุฃุตูุงู
          lines.forEach((line, index) => {
            if (index === 0) return; // ุชุฎุทู ุงูุฑุฃุณ
            
            const columns = line.split(',');
            if (columns.length > 2) {
              // ุฃุฎุฐ ุงูุนููุฏ ุงูุซุงูุซ (ุงูุนููุฏ C) ูุชูุธููู ููุฃุตูุงู
              let product = columns[2];
              if (product) {
                product = product.trim().replace(/"/g, '').replace(/'/g, '');
                
                if (product && product !== '' && product !== 'undefined') {
                  uniqueProducts.add(product); // ุฅุถุงูุฉ ูููุฌููุนุฉ ูุชุฌูุจ ุงูุชูุฑุงุฑ
                }
              }
            }
          });
          
          // ุฅุฐุง ููุฌุฏุช ุฃุตูุงู ูู Google Sheetsุ ุงุณุชุจุฏู ุงููุงุฆูุฉ
          if (uniqueProducts.size > 0) {
            // ูุณุญ ุงููุงุฆูุฉ ุงูุญุงููุฉ
            productSel.innerHTML = '';
            
            // ุฅุถุงูุฉ ุฎูุงุฑ ูุงุฑุบ ุฃููุงู
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'ุงุฎุชุฑ ุงูุตูู';
            productSel.appendChild(emptyOption);
            
            // ุฅุถุงูุฉ ุงูุฃุตูุงู ุงููุฑูุฏุฉ
            uniqueProducts.forEach(product => {
              const opt = document.createElement('option');
              opt.value = product;
              opt.textContent = product;
              productSel.appendChild(opt);
            });
            
            console.log('ุชู ุชุญุฏูุซ ุงูุฃุตูุงู ูู Google Sheets:', uniqueProducts.size, 'ุตูู ูุฑูุฏ');
            alert('ุชู ุชุญููู ุงูุฃุตูุงู ูู Google Sheets ุจูุฌุงุญ!');
          }
        })
        .catch(err => {
          console.error('ุฎุทุฃ ูู ุฌูุจ ุงูุฃุตูุงู ูู Google Sheets:', err);
          console.log('ุงุณุชุฎุฏุงู ุงูุฃุตูุงู ุงูุงุญุชูุงุทูุฉ');
        });
    }
    
    // ุงุณุชุฏุนุงุก ุฏูุงู ุงูุชุญููู
    loadCustomers();
    loadProducts();
    
    // ุชุนููู ุชุงุฑูุฎ ุงูููู ุชููุงุฆูุงู
    document.getElementById('date').valueAsDate = new Date();

    document.getElementById('supplyForm').addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('ุชู ุงูุถุบุท ุนูู ุฒุฑ ุงูุฅุฑุณุงู!');
      
      // ุฌูุน ุงูุจูุงูุงุช
      const customer = document.getElementById('customer').value;
      const mobile = document.getElementById('mobile').value;
      const date = document.getElementById('date').value;
      const product = document.getElementById('product').value;
      const qtyIn = document.getElementById('qtyIn').value;
      const qtyOut = document.getElementById('qtyOut').value;

      console.log('ุงูุจูุงูุงุช ุงููุฏุฎูุฉ:', { customer, mobile, date, product, qtyIn, qtyOut });

      // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
      if (!customer) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู');
        console.log('ุฎุทุฃ: ูู ูุชู ุงุฎุชูุงุฑ ุงูุนููู');
        return;
      }
      if (!mobile || !mobile.match(/^05[0-9]{8}$/)) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุฌูุงู ุตุญูุญ (ูุจุฏุฃ ุจู 05 ููุชููู ูู 10 ุฃุฑูุงู)');
        console.log('ุฎุทุฃ: ุฑูู ุงูุฌูุงู ุบูุฑ ุตุญูุญ:', mobile);
        return;
      }
      if (!date) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุชุงุฑูุฎ');
        console.log('ุฎุทุฃ: ูู ูุชู ุงุฎุชูุงุฑ ุงูุชุงุฑูุฎ');
        return;
      }
      if (!product) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุตูู');
        console.log('ุฎุทุฃ: ูู ูุชู ุงุฎุชูุงุฑ ุงูุตูู');
        return;
      }

      console.log('ุฌููุน ุงูุจูุงูุงุช ุตุญูุญุฉุ ุณูุชู ุงูุฅุฑุณุงู...');

      // ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู Google Apps Script
      const data = { 
        customer: customer,    // ุงูุนููุฏ B
        date: date,           // ุงูุนููุฏ C  
        qtyIn: qtyIn,         // ุงูุนููุฏ D
        qtyOut: qtyOut,       // ุงูุนููุฏ E
        product: product,     // ุงูุนููุฏ F
        mobile: mobile        // ุงูุนููุฏ G
      };
      console.log('ุฅุฑุณุงู ุงูุจูุงูุงุช:', data);

      // ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู Google Sheets ุฃููุงู
      fetch('https://script.google.com/macros/s/AKfycbyvo3ExVKbjmoCw2Nmgywep4IPEgQzl6y7zpt_HMFd8RBpXBRZGIiQ9WC0Nhl78byDS9Q/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(() => {
        console.log('ุชู ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู Google Sheets ุจูุฌุงุญ');
        alert('ุชู ุชุณุฌูู ุงูุจูุงูุงุช ุจูุฌุงุญ ูู Google Sheets!');

        // ุจุนุฏ ูุฌุงุญ ุงูุชุณุฌููุ ุชูููุฏ ุฑุงุจุท ูุงุชุณุงุจ
        const phone = '966' + mobile.slice(1);
        const message = `ุงูุนููู: *${customer}*\n` +
                        `ุงูุชุงุฑูุฎ: *${date}*\n` +
                        `ุงูุตูู: *${product}*\n` +
                        `ูููุฉ ุงูุฅุณุชูุงู: *${qtyIn}*\n` +
                        `ุงููููุฉ ุงููุณุชุฑุฏุฉ: *${qtyOut}*\n` +
                        `ุชู ุงูุชุณุฌูู ูู ุณุฌูุงุชูุง ... ูุดูุฑุง ููู`;
        
        // ุงุณุชุฎุฏุงู ุฑุงุจุท ูุงุชุณุงุจ ุงููุญุณู
        const waLink = `https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(message)}&type=phone_number&app_absent=0`;
        
        console.log('ูุชุญ ุฑุงุจุท ูุงุชุณุงุจ:', waLink);
        
        // ุฅุธูุงุฑ ุฑุงุจุท ูุงุชุณุงุจ ูุถูุงู ุฅุถุงูู
        // ุฅุธูุงุฑ ุฑุงุจุท ูุงุชุณุงุจ
        const whatsappUrl = `https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(message)}&type=phone_number&app_absent=0`;
        
        document.getElementById('whatsappUrl').href = whatsappUrl;
        document.getElementById('whatsappLink').style.display = 'block';
        
        // ุฅุถุงูุฉ ุชุฃุฎูุฑ ุตุบูุฑ ูุจู ูุชุญ ูุงุชุณุงุจ
        setTimeout(() => {
          window.open(whatsappUrl, '_blank');
        }, 500);

        // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
        document.getElementById('supplyForm').reset();
        document.getElementById('date').valueAsDate = new Date();
      })
      .catch(err => {
        console.error('ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุจูุงูุงุช:', err);
        alert('ุญุฏุซ ุฎุทุฃ ูู ุชุณุฌูู ุงูุจูุงูุงุช. ุณูุชู ูุชุญ ูุงุชุณุงุจ ุนูู ุฃู ุญุงู...');
        
        // ุญุชู ูู ูุดู ุงูุชุณุฌููุ ุณููุชุญ ูุงุชุณุงุจ
        const phone = '966' + mobile.slice(1);
        const message = `ุงูุนููู: *${customer}*\n` +
                        `ุงูุชุงุฑูุฎ: *${date}*\n` +
                        `ุงูุตูู: *${product}*\n` +
                        `ูููุฉ ุงูุฅุณุชูุงู: *${qtyIn}*\n` +
                        `ุงููููุฉ ุงููุณุชุฑุฏุฉ: *${qtyOut}*\n` +
                        `ุชู ุงูุชุณุฌูู ูู ุณุฌูุงุชูุง ... ูุดูุฑุง ููู`;
        
        const whatsappUrl = `https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(message)}&type=phone_number&app_absent=0`;
        
        document.getElementById('whatsappUrl').href = whatsappUrl;
        document.getElementById('whatsappLink').style.display = 'block';
        
        setTimeout(() => {
          window.open(whatsappUrl, '_blank');
        }, 500);

        // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
        document.getElementById('supplyForm').reset();
        document.getElementById('date').valueAsDate = new Date();
      });
    });
  </script>
</body>
</html>
