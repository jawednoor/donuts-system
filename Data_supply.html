<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>التوريد - دونات وحشوة</title>
  <link rel="icon" type="image/png" href="logo-01.png">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* تحسينات إضافية للاستجابة */
    .form-container {
      width: 100%;
      max-width: 750px; /* تكبير الحاوية */
      margin: 1rem auto;
      padding: 2rem; /* زيادة المساحة الداخلية */
      box-sizing: border-box;
    }
    
    /* تحسين الحقول للجوالات */
    @media (max-width: 480px) {
      body {
        padding: 0.5rem;
        align-items: flex-start;
        padding-top: 2rem; /* زيادة المسافة العلوية */
      }
      
      .form-container {
        margin: 0.3rem 0.3rem 2rem 0.3rem; /* تقليل المارجن السفلي */
        padding: 0.5rem 1rem 0.5rem 1rem; /* تقليل المساحة السفلية */
        max-height: calc(100vh - 1rem); /* زيادة المساحة المتاحة */
        overflow-y: auto;
        width: calc(100% - 1rem);
        position: relative;
        top: 0.3cm; /* رفع الحاوية أكثر */
      }
      
      .form-group {
        margin-bottom: 0.1rem; /* تقليل المسافة بين الحقول */
      }
      
      .form-group:first-of-type {
        margin-top: -1rem; /* تقليل المسافة من الأعلى للحقل الأول */
      }
      
      .form-group input,
      .form-group select {
        height: 55px; /* تكبير ارتفاع الحقول */
        padding: 12px 16px; /* زيادة المساحة الداخلية */
        font-size: 16px; /* تكبير الخط */
        border-radius: 10px;
        line-height: 1.3;
      }
      
      .form-group label {
        font-size: 1.2rem; /* تكبير خط التسميات */
        margin-bottom: 0.3rem;
        display: block;
      }
      
      .btn-submit {
        height: 55px; /* تكبير ارتفاع الزر */
        font-size: 1.3rem; /* تكبير خط الزر */
        margin: 1.2rem auto;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 1;
        border: none;
        border-radius: 15px;
      }
      
      .small-nav-buttons {
        margin-top: 0.3rem; /* زيادة المسافة العلوية */
        margin-bottom: 1rem;
        display: flex;
        gap: 0.5rem;
        justify-content: center; /* توسيط أفقي */
        align-items: center; /* توسيط عمودي */
      }
      
      .btn-small {
        flex: 1;
        padding: 1.3rem 0.8rem; /* تكبير المساحة الداخلية */
        font-size: 1.1rem; /* تكبير خط الأزرار */
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.2;
        border-radius: 12px; /* تحسين الحواف */
        text-decoration: none;
      }
      
      /* إخفاء الفوتر في الجوال */
      footer {
        display: none;
      }
    }
    
    /* تحسين للتابلت */
    @media (min-width: 481px) and (max-width: 768px) {
      .form-container {
        max-width: 90%; /* تكبير العرض */
        padding: 1.5rem; /* زيادة المساحة الداخلية */
        margin: 0.3rem auto;
      }
      
      .form-group {
        margin-bottom: 0.6rem; /* زيادة المسافة بين الحقول */
      }
      
      .form-group:first-of-type {
        margin-top: -0.8rem;
      }
      
      .form-group input,
      .form-group select {
        height: 55px; /* تكبير ارتفاع الحقول */
        padding: 12px 16px; /* زيادة المساحة الداخلية */
        font-size: 18px; /* تكبير حجم الخط أكثر */
        line-height: 1.3;
        border-radius: 12px;
      }
      
      .form-group label {
        font-size: 1.4rem; /* تكبير حجم خط التسميات */
        margin-bottom: 0.3rem;
        font-weight: 600;
      }
      
      .btn-submit {
        height: 55px; /* تكبير ارتفاع الزر */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        margin: 1.2rem auto;
        font-size: 1.2rem; /* تكبير حجم الخط */
        border-radius: 15px;
        font-weight: 600;
      }
      
      .btn-small {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.2rem 1.3rem; /* تكبير المساحة الداخلية */
        font-size: 1.1rem; /* تكبير الخط */
        border-radius: 12px;
        font-weight: 500;
      }
      
      .small-nav-buttons {
        margin-top: 0.2rem; /* تقليل المسافة العلوية */
        margin-bottom: 0.2rem; /* تقليل المسافة السفلية */
        gap: 0.3rem; /* تقليل المسافة بين الأزرار */
      }
      
      /* تحسين رأس النموذج للتابلت */
      .form-header h2 {
        margin-bottom: 0.2rem; /* تقليل المسافة تحت العنوان */
        font-size: 1.3rem;
      }
      
      .form-logo {
        width: 60px; /* تقليل حجم الشعار */
        height: 60px;
        margin-bottom: 0.3rem;
      }
    }
    
    /* تحسين للشاشات الكبيرة والآي باد برو */
    @media (min-width: 769px) {
      .form-container {
        max-width: 850px; /* تكبير العرض أكثر */
        padding: 2.5rem; /* زيادة المساحة الداخلية */
        margin: 1rem auto;
      }
      
      .form-group {
        margin-bottom: 1.5rem; /* زيادة المسافة بين الحقول */
      }
      
      .form-group:first-of-type {
        margin-top: 0.5rem;
      }
      
      .form-group input,
      .form-group select {
        height: 65px; /* تكبير ارتفاع الحقول أكثر */
        padding: 18px 25px; /* زيادة المساحة الداخلية */
        font-size: 20px; /* تكبير الخط أكثر */
        line-height: 1.4;
        border-radius: 15px;
      }
      
      .form-group label {
        font-size: 1.6rem; /* تكبير خط التسميات أكثر */
        margin-bottom: 0.6rem;
        font-weight: 600;
      }
      
      .btn-submit {
        height: 70px; /* تكبير ارتفاع الزر أكثر */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        margin: 2.5rem auto;
        font-size: 1.5rem; /* تكبير خط الزر أكثر */
        border-radius: 18px;
        font-weight: 600;
      }
      
      .btn-small {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem 2rem; /* تكبير المساحة الداخلية أكثر */
        font-size: 1.3rem; /* تكبير خط الأزرار الصغيرة */
        border-radius: 15px;
        font-weight: 500;
      }
      
      .small-nav-buttons {
        margin-top: 1rem;
        margin-bottom: 1rem;
        gap: 1rem; /* زيادة المسافة بين الأزرار */
      }
      
      /* تحسين رأس النموذج للشاشات الكبيرة */
      .form-header h2 {
        margin-bottom: 1rem;
        font-size: 1.8rem; /* تكبير العنوان */
      }
      
      .form-logo {
        width: 80px; /* تكبير حجم الشعار */
        height: 80px;
        margin-bottom: 0.5rem;
      }
    }
    
    /* تحسين خاص للآي باد برو والشاشات الكبيرة جداً */
    @media (min-width: 1024px) {
      .form-container {
        max-width: 950px; /* عرض أكبر للشاشات الكبيرة */
        padding: 3.5rem; /* زيادة المساحة الداخلية */
      }
      
      .form-group input,
      .form-group select {
        height: 70px; /* ارتفاع أكبر */
        padding: 20px 30px; /* مساحة داخلية أكبر */
        font-size: 22px; /* خط أكبر */
      }
      
      .form-group label {
        font-size: 1.8rem; /* خط أكبر للتسميات */
        margin-bottom: 1rem;
      }
      
      .btn-submit {
        height: 75px; /* زر أكبر */
        font-size: 1.6rem; /* خط أكبر للزر */
        margin: 3rem auto;
      }
      
      .btn-small {
        padding: 1.8rem 2.5rem; /* مساحة أكبر */
        font-size: 1.4rem; /* خط أكبر */
      }
      
      .form-header h2 {
        font-size: 2.2rem; /* عنوان أكبر */
        margin-bottom: 2rem;
      }
      
      .form-logo {
        width: 100px; /* شعار أكبر */
        height: 100px;
        margin-bottom: 1.5rem;
      }
    }
    
    /* تحسين عام للحقول */
    .form-group input,
    .form-group select {
      width: 100%;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.3s ease;
      overflow: hidden; /* منع فيض النص */
      text-overflow: ellipsis; /* إضافة نقاط عند قص النص */
      white-space: nowrap; /* منع كسر الأسطر */
    }
    
    .form-group select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23d81389' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: left 10px center; /* تحسين موضع السهم */
      background-size: 16px; /* تصغير حجم السهم */
      padding-left: 35px; /* تقليل المساحة اليسرى */
    }
    
    /* تحسين التركيز */
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #d81389;
      box-shadow: 0 0 0 3px rgba(216, 19, 137, 0.1);
      background: white;
    }
  </style>
</head>
<body>
  <main>
    <div class="form-container">
      <div class="form-header">
        <img src="logo-01.png" alt="شعار دونات وحشوة" class="form-logo">
        <h2>نموذج التوريد</h2>
      </div>
      
      <form id="supplyForm" class="payment-form">
        <div class="form-group">
          <label for="customer">اختر العميل:</label>
          <select id="customer" required>
            <option value="">اختر العميل...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="mobile">رقم جوال المستلم (واتس):</label>
          <input type="tel" id="mobile" pattern="05[0-9]{8}" placeholder="05xxxxxxxx" required>
        </div>

        <div class="form-group">
          <label for="date">تاريخ اليوم:</label>
          <input type="date" id="date" required>
        </div>

        <div class="form-group">
          <label for="product">الصنف:</label>
          <select id="product" required>
            <option value="">اختر الصنف...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="qtyIn">كمية التسليم:</label>
          <select id="qtyIn" required>
            <option value="">اختر الكمية...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="qtyOut">كمية المستردة:</label>
          <select id="qtyOut" required>
            <option value="">اختر الكمية...</option>
          </select>
        </div>

        <button type="submit" class="btn-submit"> إرسال التوريد</button>
      </form>

      <div id="whatsappLink" class="whatsapp-link" style="display: none;">
        <p>تم حفظ البيانات بنجاح! يمكنك الآن إرسال التأكيد عبر واتساب:</p>
        <a id="whatsappUrl" target="_blank" class="btn-whatsapp"> إرسال عبر واتساب</a>
      </div>

      <!-- أزرار التنقل الصغيرة -->
      <div class="small-nav-buttons">
        <a href="index.html" class="btn-small">الرئيسية</a>
        <a href="pay.html" class="btn-small">الدفعات المالية</a>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 نظام إدارة توريد الدونات والحشوة</p>
  </footer> 
  <script>
    // تعبئة الكمية من 1 إلى 100
    function fillSelect(id) {
      const sel = document.getElementById(id);
      for (let i = 0; i <= 100; i++) {
        const option = document.createElement('option');
        option.value = option.textContent = i;
        sel.appendChild(option);
      }
    }
    fillSelect('qtyIn');
    fillSelect('qtyOut');

    // جلب بيانات العملاء من Google Sheets
    function loadCustomers() {
      const customerSel = document.getElementById('customer');
      
      // إضافة خيار فارغ أولاً
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'اختر العميل';
      emptyOption.selected = true;
      customerSel.appendChild(emptyOption);
      
      // محاولة جلب البيانات من Google Sheets
      tryLoadFromGoogleSheets();
    }
    
    // محاولة جلب البيانات من Google Sheets المشارك
    function tryLoadFromGoogleSheets() {
      // استخدام رابط CSV مباشر للشيت المشارك
      const CUSTOMER_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1POl2ntUZL9x0n79Wr1_ZswEETSFUrgjMrXcFtDfoFqA/export?format=csv&gid=0';
      
      fetch(CUSTOMER_SHEET_URL)
        .then(res => res.text())
        .then(csvData => {
          console.log('تم الاتصال بـ Google Sheets بنجاح');
          console.log('CSV Data:', csvData.substring(0, 200) + '...'); // عرض أول 200 حرف للتشخيص
          
          const lines = csvData.split('\n');
          const customerSel = document.getElementById('customer');
          const uniqueCustomers = new Set(); // لتجنب التكرار
          
          // معالجة البيانات من CSV
          lines.forEach((line, index) => {
            if (index === 0) return; // تخطي الرأس
            
            const columns = line.split(',');
            if (columns.length > 1) {
              // أخذ العمود الثاني (العمود B) وتنظيفه للعملاء
              let customer = columns[1];
              if (customer) {
                customer = customer.trim().replace(/"/g, '').replace(/'/g, '');
                
                if (customer && customer !== '' && customer !== 'undefined') {
                  uniqueCustomers.add(customer); // إضافة للمجموعة لتجنب التكرار
                }
              }
            }
          });
          
          // مسح القائمة الحالية
          customerSel.innerHTML = '';
          
          // إضافة خيار فارغ أولاً
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = 'اختر العميل';
          emptyOption.selected = true;
          customerSel.appendChild(emptyOption);
          
          // إضافة العملاء الفريدين
          uniqueCustomers.forEach(customer => {
            const opt = document.createElement('option');
            opt.value = customer;
            opt.textContent = customer;
            customerSel.appendChild(opt);
          });
          
          console.log('تم تحديث البيانات من Google Sheets:', uniqueCustomers.size, 'عميل فريد');
          
          if (customerSel.options.length > 1) {
            alert('تم تحميل بيانات العملاء الحديثة من Google Sheets بنجاح!');
          }
        })
        .catch(err => {
          console.error('خطأ في جلب البيانات من Google Sheets:', err);
          console.log('استخدام البيانات الاحتياطية');
        });
    }
    
    // تحميل الأصناف من Google Sheets نفس الشيت Customer
    function loadProducts() {
      // أصناف احتياطية
      const backupProducts = ['دونات محشية', 'سينابون', 'كوكيز'];
      const productSel = document.getElementById('product');
      
      // إضافة خيار فارغ أولاً
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'اختر الصنف';
      productSel.appendChild(emptyOption);
      
      // إضافة الأصناف الاحتياطية أولاً
      backupProducts.forEach(product => {
        const opt = document.createElement('option');
        opt.value = product;
        opt.textContent = product;
        productSel.appendChild(opt);
      });
      
      console.log('تم تحميل الأصناف الاحتياطية:', backupProducts.length, 'صنف');
      
      // محاولة جلب الأصناف من Google Sheets
      tryLoadProductsFromGoogleSheets();
    }
    
    // جلب الأصناف من Google Sheets
    function tryLoadProductsFromGoogleSheets() {
      // استخدام نفس رابط الشيت Customer
      const PRODUCTS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1POl2ntUZL9x0n79Wr1_ZswEETSFUrgjMrXcFtDfoFqA/export?format=csv&gid=0';
      
      fetch(PRODUCTS_SHEET_URL)
        .then(res => res.text())
        .then(csvData => {
          console.log('تم الاتصال بـ Google Sheets لجلب الأصناف');
          
          const lines = csvData.split('\n');
          const productSel = document.getElementById('product');
          const uniqueProducts = new Set(); // لتجنب التكرار
          
          // معالجة البيانات من CSV - العمود B (مؤشر 1) للأصناف
          lines.forEach((line, index) => {
            if (index === 0) return; // تخطي الرأس
            
            const columns = line.split(',');
            if (columns.length > 2) {
              // أخذ العمود الثالث (العمود C) وتنظيفه للأصناف
              let product = columns[2];
              if (product) {
                product = product.trim().replace(/"/g, '').replace(/'/g, '');
                
                if (product && product !== '' && product !== 'undefined') {
                  uniqueProducts.add(product); // إضافة للمجموعة لتجنب التكرار
                }
              }
            }
          });
          
          // إذا وُجدت أصناف من Google Sheets، استبدل القائمة
          if (uniqueProducts.size > 0) {
            // مسح القائمة الحالية
            productSel.innerHTML = '';
            
            // إضافة خيار فارغ أولاً
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'اختر الصنف';
            productSel.appendChild(emptyOption);
            
            // إضافة الأصناف الفريدة
            uniqueProducts.forEach(product => {
              const opt = document.createElement('option');
              opt.value = product;
              opt.textContent = product;
              productSel.appendChild(opt);
            });
            
            console.log('تم تحديث الأصناف من Google Sheets:', uniqueProducts.size, 'صنف فريد');
            alert('تم تحميل الأصناف من Google Sheets بنجاح!');
          }
        })
        .catch(err => {
          console.error('خطأ في جلب الأصناف من Google Sheets:', err);
          console.log('استخدام الأصناف الاحتياطية');
        });
    }
    
    // استدعاء دوال التحميل
    loadCustomers();
    loadProducts();
    
    // تعيين تاريخ اليوم تلقائياً
    document.getElementById('date').valueAsDate = new Date();

    document.getElementById('supplyForm').addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('تم الضغط على زر الإرسال!');
      
      // جمع البيانات
      const customer = document.getElementById('customer').value;
      const mobile = document.getElementById('mobile').value;
      const date = document.getElementById('date').value;
      const product = document.getElementById('product').value;
      const qtyIn = document.getElementById('qtyIn').value;
      const qtyOut = document.getElementById('qtyOut').value;

      console.log('البيانات المدخلة:', { customer, mobile, date, product, qtyIn, qtyOut });

      // التحقق من صحة البيانات
      if (!customer) {
        alert('يرجى اختيار العميل');
        console.log('خطأ: لم يتم اختيار العميل');
        return;
      }
      if (!mobile || !mobile.match(/^05[0-9]{8}$/)) {
        alert('يرجى إدخال رقم جوال صحيح (يبدأ بـ 05 ويتكون من 10 أرقام)');
        console.log('خطأ: رقم الجوال غير صحيح:', mobile);
        return;
      }
      if (!date) {
        alert('يرجى اختيار التاريخ');
        console.log('خطأ: لم يتم اختيار التاريخ');
        return;
      }
      if (!product) {
        alert('يرجى اختيار الصنف');
        console.log('خطأ: لم يتم اختيار الصنف');
        return;
      }

      console.log('جميع البيانات صحيحة، سيتم الإرسال...');

      // إرسال البيانات إلى Google Apps Script
      const data = { 
        customer: customer,    // العمود B
        date: date,           // العمود C  
        qtyIn: qtyIn,         // العمود D
        qtyOut: qtyOut,       // العمود E
        product: product,     // العمود F
        mobile: mobile        // العمود G
      };
      console.log('إرسال البيانات:', data);

      // إرسال البيانات إلى Google Sheets أولاً
      fetch('https://script.google.com/macros/s/AKfycbyvo3ExVKbjmoCw2Nmgywep4IPEgQzl6y7zpt_HMFd8RBpXBRZGIiQ9WC0Nhl78byDS9Q/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(() => {
        console.log('تم إرسال البيانات إلى Google Sheets بنجاح');
        alert('تم تسجيل البيانات بنجاح في Google Sheets!');

        // بعد نجاح التسجيل، توليد رابط واتساب
        const phone = '966' + mobile.slice(1);
        const message = `العميل: *${customer}*\n` +
                        `التاريخ: *${date}*\n` +
                        `الصنف: *${product}*\n` +
                        `كمية الإستلام: *${qtyIn}*\n` +
                        `الكمية المستردة: *${qtyOut}*\n` +
                        `تم التسجيل في سجلاتنا ... وشكرا لكم`;
        
        // استخدام رابط واتساب المحسن
        const waLink = `https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(message)}&type=phone_number&app_absent=0`;
        
        console.log('فتح رابط واتساب:', waLink);
        
        // إظهار رابط واتساب كضمان إضافي
        // إظهار رابط واتساب
        const whatsappUrl = `https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(message)}&type=phone_number&app_absent=0`;
        
        document.getElementById('whatsappUrl').href = whatsappUrl;
        document.getElementById('whatsappLink').style.display = 'block';
        
        // إضافة تأخير صغير قبل فتح واتساب
        setTimeout(() => {
          window.open(whatsappUrl, '_blank');
        }, 500);

        // إعادة تعيين النموذج
        document.getElementById('supplyForm').reset();
        document.getElementById('date').valueAsDate = new Date();
      })
      .catch(err => {
        console.error('خطأ في إرسال البيانات:', err);
        alert('حدث خطأ في تسجيل البيانات. سيتم فتح واتساب على أي حال...');
        
        // حتى لو فشل التسجيل، سنفتح واتساب
        const phone = '966' + mobile.slice(1);
        const message = `العميل: *${customer}*\n` +
                        `التاريخ: *${date}*\n` +
                        `الصنف: *${product}*\n` +
                        `كمية الإستلام: *${qtyIn}*\n` +
                        `الكمية المستردة: *${qtyOut}*\n` +
                        `تم التسجيل في سجلاتنا ... وشكرا لكم`;
        
        const whatsappUrl = `https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(message)}&type=phone_number&app_absent=0`;
        
        document.getElementById('whatsappUrl').href = whatsappUrl;
        document.getElementById('whatsappLink').style.display = 'block';
        
        setTimeout(() => {
          window.open(whatsappUrl, '_blank');
        }, 500);

        // إعادة تعيين النموذج
        document.getElementById('supplyForm').reset();
        document.getElementById('date').valueAsDate = new Date();
      });
    });
  </script>
</body>
</html>