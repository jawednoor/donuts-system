<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إدخال دفعة مالية - دونات وحشوة</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>💰 إدخال دفعة مالية</h1>
    <nav>
      <a href="index.html">🏠 الرئيسية</a>
      <a href="Data_supply.html">📦 صفحة التوريد</a>
      <a href="pay.html">💰 الدفعات المالية</a>
    </nav>
  </header>

  <main>
    <div class="form-container">
      <div class="form-header">
        <img src="logo-01.png" alt="شعار دونات وحشوة" class="form-logo">
        <h2>تسجيل دفعة مالية</h2>
      </div>
      
      <form id="paymentForm" class="payment-form">
        <div class="form-group">
          <label for="customer">اختر العميل:</label>
          <select id="customer" name="customer" required>
            <option value="">اختر العميل...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="paymentDate">تاريخ الدفع:</label>
          <input type="date" id="paymentDate" name="paymentDate" required>
        </div>

        <div class="form-group">
          <label for="amount">المبلغ:</label>
          <input type="number" id="amount" name="amount" step="0.01" min="0" placeholder="أدخل المبلغ" required>
        </div>

        <div class="form-group">
          <label for="paymentMethod">طريقة الدفع:</label>
          <select id="paymentMethod" name="paymentMethod" required>
            <option value="">اختر طريقة الدفع...</option>
            <option value="نقدي">نقدي</option>
            <option value="تحويل بنكي">تحويل بنكي</option>
            <option value="شيك">شيك</option>
            <option value="بطاقة ائتمان">بطاقة ائتمان</option>
          </select>
        </div>

        <div class="form-group">
          <label for="notes">ملاحظات (اختياري):</label>
          <textarea id="notes" name="notes" rows="3" placeholder="أدخل أي ملاحظات إضافية"></textarea>
        </div>

        <div class="form-group">
          <label for="mobile">رقم الجوال:</label>
          <input type="tel" id="mobile" name="mobile" placeholder="05xxxxxxxx" pattern="[0-9]{10}" required>
        </div>

        <button type="submit" class="btn-submit">💾 حفظ الدفعة</button>
      </form>

      <div id="whatsappLink" class="whatsapp-link" style="display: none;">
        <p>تم حفظ البيانات بنجاح! يمكنك الآن إرسال التأكيد عبر واتساب:</p>
        <a id="whatsappUrl" target="_blank" class="btn-whatsapp">📱 إرسال عبر واتساب</a>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 نظام إدارة توريد الدونات والحشوة</p>
  </footer>

  <script>
    // تحميل قائمة العملاء من Google Sheets
    async function loadCustomers() {
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/1POl2ntUZL9x0n79Wr1_ZswEETSFUrgjMrXcFtdfoFqA/export?format=csv&gid=0');
        const csvData = await response.text();
        const lines = csvData.split('\n');
        const customerSelect = document.getElementById('customer');
        
        for (let i = 1; i < lines.length; i++) {
          const columns = lines[i].split(',');
          if (columns[1] && columns[1].trim()) {
            const option = document.createElement('option');
            option.value = columns[1].trim();
            option.textContent = columns[1].trim();
            customerSelect.appendChild(option);
          }
        }
      } catch (error) {
        console.error('خطأ في تحميل العملاء:', error);
      }
    }

    // تعيين التاريخ الحالي
    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

    // تحميل العملاء عند تحميل الصفحة
    window.addEventListener('load', loadCustomers);

    // معالجة إرسال النموذج
    document.getElementById('paymentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      try {
        // إرسال البيانات إلى Google Sheets
        const response = await fetch('https://script.google.com/macros/s/AKfycbyvo3ExVKbjmoCw2Nmgywep4IPEgQzl6y7zpt_HMFd8RBpXBRZGIiQ9WC0Nhl78byDS9Q/exec', {
          method: 'POST',
          body: JSON.stringify({
            customer: data.customer,
            date: data.paymentDate,
            amount: data.amount,
            paymentMethod: data.paymentMethod,
            notes: data.notes || '',
            mobile: data.mobile,
            type: 'payment'
          }),
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (response.ok) {
          // إنشاء رسالة واتساب
          const message = `🔔 تأكيد دفعة مالية جديدة\n\n` +
                         `👤 العميل: ${data.customer}\n` +
                         `📅 التاريخ: ${data.paymentDate}\n` +
                         `💰 المبلغ: ${data.amount} ريال\n` +
                         `💳 طريقة الدفع: ${data.paymentMethod}\n` +
                         `📝 ملاحظات: ${data.notes || 'لا توجد'}\n\n` +
                         `شكراً لكم 🙏\n` +
                         `دونات وحشوة 🍩`;

          const whatsappUrl = `https://api.whatsapp.com/send/?phone=966${data.mobile.substring(1)}&text=${encodeURIComponent(message)}`;
          
          document.getElementById('whatsappUrl').href = whatsappUrl;
          document.getElementById('whatsappLink').style.display = 'block';
          
          // إعادة تعيين النموذج
          this.reset();
          document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
          
          alert('تم حفظ الدفعة بنجاح!');
        } else {
          throw new Error('فشل في حفظ البيانات');
        }
      } catch (error) {
        console.error('خطأ:', error);
        alert('حدث خطأ في حفظ البيانات. يرجى المحاولة مرة أخرى.');
      }
    });
  </script>
</body>
</html>
